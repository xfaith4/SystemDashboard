{% extends 'base.html' %}
{% block content %}
<section class="dashboard">
    <header class="dashboard-header">
        <div class="dashboard-title">
            <p class="eyebrow">Realtime Reliability</p>
            <h1>Operations Telemetry Overview</h1>
            <p class="subtitle">Blended signals from IIS, authentication, Windows event logs, router telemetry, and syslog.</p>
        </div>
        <div class="drill-actions">
            <a class="drill-button" href="{{ url_for('events') }}">View Windows Events</a>
            <a class="drill-button" href="{{ url_for('router') }}">Router & WAN Logs</a>
            <a class="drill-button" href="{{ url_for('wifi') }}">Wi‑Fi Clients</a>
        </div>
        {% if summary.using_mock %}
        <p class="notice">Displaying sample data because the database connection could not be established.</p>
        {% endif %}
    </header>

    <section class="pulse-strip">
        <article class="pulse-card" data-series-key="iis_errors">
            <div class="pulse-top">
                <div>
                    <p class="eyebrow">IIS 5xx (7d)</p>
                    <h3 id="pulse-iis-total">--</h3>
                </div>
                <span class="pill pill-error">Error</span>
            </div>
            <div class="pulse-meta">
                <span>Last 24h vs 7d median</span>
                <span class="delta" id="pulse-iis-delta">--</span>
            </div>
            <svg class="sparkline" id="spark-iis" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </article>
        <article class="pulse-card" data-series-key="auth_failures">
            <div class="pulse-top">
                <div>
                    <p class="eyebrow">Auth Failures (7d)</p>
                    <h3 id="pulse-auth-total">--</h3>
                </div>
                <span class="pill pill-warn">Auth</span>
            </div>
            <div class="pulse-meta">
                <span>Bursts per day</span>
                <span class="delta" id="pulse-auth-delta">--</span>
            </div>
            <svg class="sparkline" id="spark-auth" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </article>
        <article class="pulse-card" data-series-key="windows_errors">
            <div class="pulse-top">
                <div>
                    <p class="eyebrow">Windows Critical/Error (7d)</p>
                    <h3 id="pulse-windows-total">--</h3>
                </div>
                <span class="pill pill-info">OS</span>
            </div>
            <div class="pulse-meta">
                <span>Noise floor vs spikes</span>
                <span class="delta" id="pulse-windows-delta">--</span>
            </div>
            <svg class="sparkline" id="spark-windows" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </article>
        <article class="pulse-card" data-series-key="router_alerts">
            <div class="pulse-top">
                <div>
                    <p class="eyebrow">Router Alerts (7d)</p>
                    <h3 id="pulse-router-total">--</h3>
                </div>
                <span class="pill pill-accent">WAN</span>
            </div>
            <div class="pulse-meta">
                <span>WAN/DHCP/auth anomalies</span>
                <span class="delta" id="pulse-router-delta">--</span>
            </div>
            <svg class="sparkline" id="spark-router" viewBox="0 0 120 36" preserveAspectRatio="none"></svg>
        </article>
    </section>

    <!-- 7-Day Trend Graphs Section -->
    <section class="trends-section">
        <h2>7-Day Trend Analysis</h2>
        <div class="charts-grid">
            <article class="chart-card">
                <h3>IIS 5xx Errors</h3>
                <div id="iisErrorsChart" class="chart-placeholder">Loading...</div>
            </article>
            <article class="chart-card">
                <h3>Authentication Failures</h3>
                <div id="authFailuresChart" class="chart-placeholder">Loading...</div>
            </article>
            <article class="chart-card">
                <h3>Windows Critical/Error Events</h3>
                <div id="windowsErrorsChart" class="chart-placeholder">Loading...</div>
            </article>
            <article class="chart-card">
                <h3>Router Alerts</h3>
                <div id="routerAlertsChart" class="chart-placeholder">Loading...</div>
            </article>
        </div>
    </section>

    <div class="kpi-grid">
        <article class="kpi-card{% if summary.iis.spike %} alert{% endif %}">
            <h2>IIS 5xx (last 5 min)</h2>
            <p class="metric">{{ summary.iis.current_errors }}</p>
            <p class="detail">Baseline {{ summary.iis.baseline_avg }} ± {{ summary.iis.baseline_std }}</p>
            <p class="detail">Total requests {{ summary.iis.total_requests }}</p>
            {% if summary.iis.spike %}
            <p class="alert-text">Spike detected &mdash; investigate immediately.</p>
            {% endif %}
        </article>
        <article class="kpi-card">
            <h2>Auth Bursts (15 min)</h2>
            <p class="metric">{{ summary.auth|length }}</p>
            <p class="detail">Threshold ≥ {{ auth_threshold }} failures per client</p>
        </article>
        <article class="kpi-card">
            <h2>Critical Windows Events</h2>
            <p class="metric">{{ summary.windows|length }}</p>
            <p class="detail">Evaluated across the last 10 minutes</p>
        </article>
        <article class="kpi-card">
            <h2>Router Alerts</h2>
            <p class="metric">{{ summary.router|length }}</p>
            <p class="detail">ASUS WAN/DHCP/auth anomalies</p>
        </article>
    </div>
</section>

<section class="panel-grid">
    <article class="panel">
        <h2>Authentication Bursts (15 min window)</h2>
        {% if summary.auth %}
        <table class="data-table">
            <thead>
                <tr><th>Client IP</th><th>Failures</th><th>Last Seen</th></tr>
            </thead>
            <tbody>
                {% for item in summary.auth %}
                <tr>
                    <td>{{ item.client_ip }}</td>
                    <td>{{ item.count }}</td>
                    <td>{{ item.last_seen }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No authentication storms detected in the last 15 minutes.</p>
        {% endif %}
    </article>
    <article class="panel">
        <h2>Windows Critical/Error Events (last 10 min)</h2>
        {% if summary.windows %}
        <table class="data-table">
            <thead>
                <tr><th>Time</th><th>Source</th><th>Level</th><th>ID</th><th>Message</th></tr>
            </thead>
            <tbody>
                {% for evt in summary.windows %}
                <tr>
                    <td>{{ evt.time }}</td>
                    <td>{{ evt.source }}</td>
                    <td>{{ evt.level }}</td>
                    <td>{{ evt.id }}</td>
                    <td class="wrap">{{ evt.message }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
        {% else %}
        <p class="empty">No critical or error-level Windows events detected in the last ten minutes.</p>
        {% endif %}
    </article>
</section>

<section class="panel">
    <h2>ASUS Router Alerts</h2>
    {% if summary.router %}
    <table class="data-table">
        <thead>
            <tr><th>Time</th><th>Severity</th><th>Message</th><th>Host</th></tr>
        </thead>
        <tbody>
            {% for log in summary.router %}
            <tr>
                <td>{{ log.time }}</td>
                <td>{{ log.severity }}</td>
                <td class="wrap">{{ log.message }}</td>
                <td>{{ log.host }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">No router anomalies captured in the recent window.</p>
    {% endif %}
</section>

<section class="panel">
    <h2>Latest Syslog Entries</h2>
    {% if summary.syslog %}
    <table class="data-table">
        <thead>
            <tr><th>Time</th><th>Source</th><th>Severity</th><th>Message</th></tr>
        </thead>
        <tbody>
            {% for entry in summary.syslog %}
            <tr>
                <td>{{ entry.time }}</td>
                <td>{{ entry.source }}</td>
                <td>{{ entry.severity }}</td>
                <td class="wrap">{{ entry.message }}</td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
    {% else %}
    <p class="empty">No recent syslog messages captured yet.</p>
    {% endif %}
</section>

{% endblock %}

{% block extra_scripts %}
<script defer src="{{ url_for('static', filename='dashboard.js') }}"></script>
{% endblock %}
