name: PowerShell Dashboard Test

on: [push, pull_request]

jobs:
  test-dashboard:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run dashboard script headless
        shell: pwsh
        run: |
          Import-Module .\Start-SystemDashboard.psm1 -Force

          $job = Start-Job -ScriptBlock {
            param($scriptRoot)
            Import-Module "$scriptRoot\Start-SystemDashboard.psm1" -Force
            & "$scriptRoot\Start-SystemDashboard.ps1" -Mode Legacy -SkipPreflight -SkipDatabaseCheck -SkipInstall
          } -ArgumentList $PWD
          
          $maxAttempts = 20
          $attempt = 0
          $uri = 'http://localhost:15000/'
          
          try {
            Write-Host "Polling for dashboard readiness at $uri..."
            while ($attempt -lt $maxAttempts) {
              if ($job.State -in @('Failed','Completed','Stopped')) {
                $jobDetails = Receive-Job $job -ErrorAction SilentlyContinue
                throw "Dashboard job (Id: $($job.Id)) ended unexpectedly with state $($job.State). Details: $jobDetails"
              }
              $attempt++
              try {
                $response = Invoke-WebRequest -Uri $uri -UseBasicParsing -TimeoutSec 2
                if ($response.StatusCode -eq 200) {
                  Write-Host "✓ Dashboard responded after $($attempt * 2) seconds"
                  break
                }
              } catch {
                Write-Host "Attempt ${attempt}/${maxAttempts}: Waiting for dashboard..."
              }
              Start-Sleep -Seconds 2
            }

            if ($attempt -ge $maxAttempts) {
              throw "Dashboard failed to respond at $uri after $($maxAttempts * 2) seconds."
            }

            Write-Host "✓ Dashboard is running successfully"
          }
          finally {
            if ($job) {
              try { Stop-Job $job -ErrorAction Stop } catch { Write-Warning "Failed to stop dashboard job: $($_.Exception.Message)" }
              try { Remove-Job $job -ErrorAction Stop } catch { Write-Warning "Failed to remove dashboard job: $($_.Exception.Message)" }
            }
          }
