name: PowerShell Dashboard Test

on: [push, pull_request]

jobs:
  test-dashboard:
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run dashboard script headless
        shell: pwsh
        run: |
          # Import module and start listener in background
          Import-Module .\Start-SystemDashboard.psm1 -Force
          
          # Start the dashboard in a background job
          $job = Start-Job -ScriptBlock {
            param($scriptRoot)
            Import-Module "$scriptRoot\Start-SystemDashboard.psm1" -Force
            . "$scriptRoot\Start-SystemDashboard.ps1"
          } -ArgumentList $PWD
          
          # Wait for the HTTP endpoint to come up
          $maxAttempts = 15
          $attempt = 0
          $uri = 'http://localhost:15000/'
          
          Write-Host "Polling for dashboard readiness..."
          while ($attempt -lt $maxAttempts) {
           Start-Sleep -Seconds 2
            Receive-Job $job -Keep | Write-Host
            $attempt++
            try {
              $response = Invoke-WebRequest -Uri $uri -UseBasicParsing -TimeoutSec 2
              if ($response.StatusCode -eq 200) {
                Write-Host "✓ Dashboard responded after $($attempt * 2) seconds"
                break
              }
            } catch {
              Write-Host "Attempt ${attempt}/${maxAttempts}: Waiting for dashboard..."
            }
          }
          
          if ($attempt -ge $maxAttempts) {
            # Clean up and fail with a clear message
            Stop-Job $job -ErrorAction SilentlyContinue
            Remove-Job $job -ErrorAction SilentlyContinue
            throw "Dashboard failed to respond at $uri after $($maxAttempts * 2) seconds."
          }
          
          Write-Host "✓ Dashboard is running successfully"
          
          # Cleanup
          Stop-Job $job | Remove-Job
