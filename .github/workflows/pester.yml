name: CI - Dashboard Script Tests

on:
  push:
    paths:
      - '**/*.ps1'
  workflow_dispatch:

jobs:
  lint-and-unit-tests:
    runs-on: windows-latest
    strategy:
      matrix:
        pwsh-version: [ '7.2.0', '7.4.0' ]
    steps:
      - uses: actions/checkout@v3

      - name: Set up PowerShell Core
        uses: actions/setup-powershell@v3
        with:
          version: ${{ matrix.pwsh-version }}

      - name: Install PSScriptAnalyzer
        run: Install-Module -Name PSScriptAnalyzer -Scope CurrentUser -Force

      - name: Lint with PSScriptAnalyzer
        run: |
          $scriptPath = '.\SystemDashboard.ps1'
          Invoke-ScriptAnalyzer -Path $scriptPath -Recurse -Severity Warning,Error

      - name: Unit test Get-Metrics output shape
        run: |
          $script = '.\SystemDashboard.ps1'
          $metrics = & $script -Port 9000 -WanProbeHost '127.0.0.1' -DesiredDriveLetters '' -EventProvidersOfInterest '' -HotMessageKeywords '' -OpenBrowser:$false
          if (-not ($metrics -is [PSCustomObject])) { throw 'Get-Metrics did not return a PSCustomObject' }
          foreach ($prop in 'ComputerName','Timestamp','CPU','Memory','Disks','Network','Events','TopProcesses') {
            if (-not $metrics.PSObject.Properties.Name -contains $prop) { throw "Missing property: $prop" }
          }
          # CPU.UsagePct numeric?
          if (-not ($metrics.CPU.UsagePct -is [double] -or $metrics.CPU.UsagePct -is [int])) { throw 'CPU.UsagePct is not numeric' }
          Write-Host "Metrics shape validated."

      - name: Smoke test HTTP endpoint
        run: |
          $script = '.\SystemDashboard.ps1'
          Start-Process -FilePath pwsh -ArgumentList "-NoProfile", "-Command", "& { . $script -Port 9111 -WanProbeHost '127.0.0.1' -DesiredDriveLetters '' -EventProvidersOfInterest '' -HotMessageKeywords '' -OpenBrowser:$false }" -PassThru
          Start-Sleep -Seconds 3
          $response = Invoke-WebRequest -Uri 'http://localhost:9111/metrics' -UseBasicParsing -ErrorAction Stop
          if ($response.StatusCode -ne 200) { throw "Expected HTTP 200, got $($response.StatusCode)" }
          $json = $response.Content | ConvertFrom-Json
          if (-not $json.ComputerName) { throw "JSON missing ComputerName" }
          Write-Host "HTTP /metrics endpoint is responding."
          # Stop the dashboard process
          Stop-Process -Id $LASTEXITCODE -ErrorAction SilentlyContinue

      - name: Cleanup (ensure no lingering listeners)
        run: |
          # Attempt to stop any process listening on 9111
          $p = Get-NetTCPConnection -LocalPort 9111 -State Listen -ErrorAction SilentlyContinue
          if ($p) {
            Stop-Process -Id $p.OwningProcess -Force -ErrorAction SilentlyContinue
          }
