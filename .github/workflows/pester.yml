### BEGIN FILE: .github/workflows/ci-dashboard.yml
name: CI - Dashboard Script Tests

on:
  push:
    paths:
      - '**/*.ps1'
  workflow_dispatch:

jobs:
  lint-and-unit-tests:
    name: lint-and-unit-tests (pwsh ${{ matrix.pwsh }})
    runs-on: windows-latest
    strategy:
      fail-fast: false
      matrix:
        include:
          # Built-in on windows-latest; skip install to avoid flaky MSI downloads.
          - pwsh: '7.4.x'
            install: false
          # Keep this leg to guarantee compatibility with older engine.
          - pwsh: '7.2.x'
            install: true

    defaults:
      run:
        shell: pwsh

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # Optional: cache user modules to speed up repeated runs
      - name: Cache PowerShell modules
        uses: actions/cache@v4
        with:
          path: ${{ env.USERPROFILE }}\Documents\PowerShell\Modules
          key: psmodules-${{ runner.os }}-${{ hashFiles('**/*.psd1') }}
          restore-keys: |
            psmodules-${{ runner.os }}-

      # Install only when needed (7.2.x). We use retry around a script installer
      # because you can't "retry" a composite action.
      - name: Install PowerShell ${{ matrix.pwsh }} (retry)
        if: matrix.install == true
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 10
          max_attempts: 3
          command: |
            pwsh -NoProfile -Command "
              Set-StrictMode -Version Latest
              $ErrorActionPreference = 'Stop'
              iex (irm 'https://raw.githubusercontent.com/PSModule/Install-PowerShell/main/install-latest.ps1')
              Install-PowerShell -Version '${{ matrix.pwsh }}' -Quiet -ErrorAction Stop
            "

      - name: Verify PowerShell version
        run: |
          'Using pwsh: ' + (Get-Command pwsh).Source
          $PSVersionTable.PSVersion

      # Install PSScriptAnalyzer with retries (the Gallery hiccups sometimes)
      - name: Install PSScriptAnalyzer (retry)
        uses: nick-fields/retry@v3
        with:
          timeout_minutes: 5
          max_attempts: 3
          command: |
            pwsh -NoProfile -Command "
              Set-StrictMode -Version Latest
              $ErrorActionPreference = 'Stop'
              if (-not (Get-PSRepository -Name PSGallery).InstallationPolicy -eq 'Trusted') {
                Set-PSRepository -Name PSGallery -InstallationPolicy Trusted
              }
              Install-Module PSScriptAnalyzer -Scope CurrentUser -Force -ErrorAction Stop
            "

      - name: Lint with PSScriptAnalyzer
        run: |
          $scriptPath = '.\SystemDashboard.ps1'
          Invoke-ScriptAnalyzer -Path $scriptPath -Recurse -Severity Warning,Error

      - name: Unit test Get-Metrics output shape
        run: |
          $script  = '.\SystemDashboard.ps1'
          $metrics = & $script -Port 9000 -WanProbeHost '127.0.0.1' `
                               -DesiredDriveLetters '' `
                               -EventProvidersOfInterest '' `
                               -HotMessageKeywords '' `
                               -OpenBrowser:$false

          # --- Assertions ----------------------------------------------------
          if (-not ($metrics -is [pscustomobject])) {
            throw 'Get-Metrics did not return a PSCustomObject'
          }

          foreach ($prop in 'ComputerName','Timestamp','CPU','Memory','Disks','Network','Events','TopProcesses') {
            if (-not $metrics.PSObject.Properties.Name -contains $prop) {
              throw "Missing property: $prop"
            }
          }

          if (-not ($metrics.CPU.UsagePct -is [double] -or $metrics.CPU.UsagePct -is [int])) {
            throw 'CPU.UsagePct is not numeric'
          }

          Write-Host 'Metrics shape validated.'

      - name: Smoke test HTTP endpoint (poll, random port)
        run: |
          $script = '.\SystemDashboard.ps1'
          $port   = Get-Random -Minimum 20000 -Maximum 40000

          # Make sure nothing is already on the chosen port (paranoid cleanup)
          Get-NetTCPConnection -LocalPort $port -State Listen -ErrorAction SilentlyContinue |
            Select-Object -ExpandProperty OwningProcess -Unique |
            ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue }

          $proc = Start-Process -FilePath pwsh -ArgumentList @(
            '-NoProfile','-ExecutionPolicy','Bypass','-Command',
            "& { . $script -Port $port -WanProbeHost '127.0.0.1' -DesiredDriveLetters '' -EventProvidersOfInterest '' -HotMessageKeywords '' -OpenBrowser:`$false }"
          ) -PassThru

          try {
            $deadline = (Get-Date).AddSeconds(30)
            $ok = $false
            do {
              Start-Sleep -Seconds 1
              try {
                $r = Invoke-WebRequest -Uri \"http://localhost:$port/metrics\" -UseBasicParsing -TimeoutSec 3
                if ($r.StatusCode -eq 200) { $ok = $true }
              } catch { }
            } while (-not $ok -and (Get-Date) -lt $deadline)

            if (-not $ok) { throw \"Endpoint never returned 200 within 30s on port $port.\" }

            $json = $r.Content | ConvertFrom-Json
            if (-not $json.ComputerName) { throw 'JSON missing ComputerName' }

            Write-Host \"HTTP /metrics OK on port $port\"
          }
          finally {
            if ($proc -and -not $proc.HasExited) {
              Stop-Process -Id $proc.Id -Force -ErrorAction SilentlyContinue
            }
          }

      - name: Cleanup (ensure no lingering listeners)
        run: |
          # Sweep any dashboard instances left behind (both fixed and random-range ports)
          foreach ($p in 9111..9113) {
            Get-NetTCPConnection -LocalPort $p -State Listen -ErrorAction SilentlyContinue |
              Select-Object -ExpandProperty OwningProcess -Unique |
              ForEach-Object { Stop-Process -Id $_ -Force -ErrorAction SilentlyContinue }
          }
### END FILE
